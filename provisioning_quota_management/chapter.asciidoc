[[quota-management]]
== Управление квотой

В последней главе мы увидели, как каждый запрос на подготовку виртуальной машины или экземпляра включает в себя процесс утверждения, и что запросы на более крупные виртуальные машины обычно требуют административного одобрения. Тем не менее, даже с порогами автоматического одобрения, установленными в их низких значениях по умолчанию, наши пользователи все еще могут со временем создавать большое количество небольших виртуальных машин, потреблять наши ресурсы виртуальной инфраструктуры и увеличить затраты на облачные.

По этой причине CloudForms и Manageiq также позволяют нам устанавливать квоты на арендаторах или группах пользователей. Квоты могут быть установлены для количества виртуальных машин, количества процессоров, количества памяти или количества хранилища, принадлежащего »арендатором или группой. Если запрос на подготовку виртуальной машины приведет к превышению квоты, запрос отклоняется, и запрошенный пользователь отправляется по электронной почте.

Квоты не включены по умолчанию, но они просты для включения и настройки.

=== Quota in CloudForms 4.0

Управление квотой было полностью переписано для CloudForms 4.0/Manageiq _capablanca_. Перед этим выпуском управление квотами для инстанции облака, виртуальная машина инфраструктуры и предоставление услуг обрабатывалось в разных местах в соответствующих _/cloud_, _/infrastructure_ и _/service_paces. В _capablanca_ они были объединены в _/system/commonmethods_ в автоматическом хранилище данных. (См. << i1 >>).

[[i1]]
. Классы, экземпляры и методы
image::images/ss1.png[Screenshot,260,align="center"]
{zwsp} +

Экземпляр _manageiq/system/commonmethods/QuatastateMachine/Quata_ State имеет значения поля, показанные в << i2 >>.

[[i2]]
.Schema of the Quatate State Machine
image::images/ss2.png[Screenshot,700,align="center"]
{zwsp} +

Мы видим, что обработка квот следует за простым рабочим процессом:

1. Определите источник квоты
2. Определите ограничения квоты, назначенные этому источнику
3. Определите ресурсы, используемые в настоящее время этим источником
4. Определите новые ресурсы, запрошенные источником
5. Убедитесь, будет ли новая запрашиваемая сумма превышать квоту

==== Quota Source

Новая концепция с переосмысленным механизмом управления квотой-это концепция _quota source_. Это объект, к которой применяется квота, и по умолчанию является арендатор. Квоты арендатора могут быть отредактированы в Webui в разделе ** Configure -> Configuration -> Control -> Andunts -> _tenant _ ** (см. << i3 >>).

[[i3]]
.Sting Quatats для арендатора
image::images/ss3.png[Screenshot,700,align="center"]
{zwsp} +

Объект арендатора отслеживает выделенные значения в виртуальных столбцах:

....
--- virtual columns follow ---
$ evm.root ['endant']. Allocated_memory = 48318382080 (тип: fixnum)
$ evm.root ['endant']. Allocated_storage = 498216206336 (тип: fixnum)
$ evm.root ['endant']. allocated_vcpu = 23 (тип: fixnum)
$ evm.root ['endant']. provisioned_storage = 546534588416 (тип: fixnum)
....

===== Alternative Quota Sources

Если мы хотим использовать альтернативный источник квоты, мы сможем скопировать экземпляр Match Match wation_ в наш собственный домен и редактировать * quota_source_type * атрибут. Если мы установим это как «группу», группа пользователя, предназначенную, будет использоваться в качестве источника квоты, а обработка квот будет обрабатываться в Pre-Cloudforms 4.0. Мы можем установить квоту двумя способами.

===== Defining Quota in the State Machine Schema (the model)

Мы можем установить общие значения Warn и Max для *VM Count *, *Storage *, *CPU *и *MEMOM *, копировав экземпляр _ManageIQ/System/CommonMethods/QuataTateMachine/Quata_ и редактируя любые из восьми атрибутов схемы.

Квоты, определенные в модели таким образом, применимы ко всем случаям источника квоты (например, все группы)

===== Defining Quota Using Tags

Мы можем переопределить атрибуты модели по умолчанию, применяя теги из одной или нескольких из следующих категорий тегов в отдельные объекты источника квот (например, отдельные группы):

[cols="^,^,^",options="header",]
|==============================================================
| Имя категории тегов | Имя категории тегов |
| quota_warn_vms | Quotta - WARN VMS | Нет; Должен быть создан
| quota_max_vms | Quotta - max vms | no; Должен быть создан
| quota_warn_storage | Quotta - Warn Storage | Нет; Должен быть создан
| quota_max_storage | Квота - максимальное хранилище | Да
| QUOTA_WARN_CPU | Квота - ПРЕДУПРЕЖДЕНИЕ CPU | Нет; Должен быть создан
| quata_max_cpu | Quotata - MAX CPU | Да
| quota_warn_memory | Quotta - Warn Memory | Нет; Должен быть создан
| quata_max_memory | Quotata - Max Memory | Да
|==============================================================

Если группа помечена таким образом, то любой виртуальная машина или запрос на предоставление услуг от любого участника группы сопоставляется с в настоящее время выделенными процессорами, памятью или хранилищами для группы.

Если квоты определены как в модели, так и с тегами, тегическое значение имеет приоритет.

=== Quota Workflow

Процесс проверки квот для запроса о предоставлении виртуальной машины или экземпляра запускается со событием * request_starting * (см. << i4 >>)

[[i4]]
.EVENT-инициализированный запрос на предоставление Квота Рабочий процесс
image::images/quota_workflow.png[Screenshot,350,align="center"]
{zwsp} +

Эта политика событий обрабатывается _/system/policy/miqprovisionrequest_starting_ экземпляр политики, который имеет одно * rel5 * соотношение, которое называет машину _/system/commonmethods/QuataTateMachine/Quata_.

Если запрос на предоставление приведет к превышению квоты, то запрос отклоняется, а запрашивающий пользователь отправляется по электронной почте через _/{инфраструктуру, Cloud}/VM/Provisioning/Email/MiqProvisionRequest_denied_ Email Class.

Если запрос находится в рамках квоты, то рабочий процесс просто выходит.

=== Summary

Квоты позволяют нам сохранять определенную степень контроля над истощением наших дорогих ресурсов виртуализации, и все же позволяет нашим пользователям создавать свои собственные виртуальные машины или экземпляры.

Квоты могут быть применены к контрольным группам или арендаторам. Квота, выделенная арендатору, может быть дополнительно разделена между любыми детьми или проектами арендатора. Например, у нас может быть арендатор, представляющий нашу группу по разработке приложений, и у них могут быть проекты арендаторов, представляющие приложения, которые в настоящее время находятся в разработке. Мы можем выделить роль * evmrole-tenant_quota_administrator * контроля доступа к администратору виртуализации, который затем может дополнительно подразделять квоту группы разработчиков между проектами, как запрошенные.

Когда мы применяем квоты для доступа к группам управления, мы можем дополнительно пометить группы с помощью тегов _warn_ и _max_ по пороге на основе, чтобы точно настроить распределение квот.

==== Further Reading

https://github.com/manageiq/manageiq/pull/4338* Служба Сервиса/VM Quata Validation]
